# Node.js

> Node.js®는 Chrome V8 JavaScript 엔진으로 빌드된 JavaScript 런타임입니다. Node.js는 이벤트 기반, 논블로킹 I/O 모델을 사용해 가볍고 효율적입니다. Node.js의 패키지 생태계인 npm은 세계에서 가장 큰 오픈 소스 라이브러리 생태계이기도 합니다. 

## 1. 서버

노드를 이용해 다양한 자바스크립트 애플리케이션을 실행할 수 있는데, 특히 서버 애플리케이션을 실행하는데 가장 많이 사용한다.  
**서버는 네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램을 말한다.**

- 클라이언트: 요청을 보내는 주체(브라우저, 데스크톱 프로그램, 모바일 앱 또는 다른 서버에 요청을 보내는 서버)
- 서버: 클라이언트의 요청에 대한 응답을 하거나 또다른 서버에 요청을 보냄

### 1.2. 자바스크립트 런타임

특정 언어로 만든 프로그램들을 실행할 수 있는 환경  
노드는 자바스크립트 프로그램을 컴퓨터에서 실행할 수 있게 함

구글의 V8 엔진은 기존에 속도 문제로 인터넷 브라우저에서만 실행할 수 있었던 자바스크립트를 빠르게 실행할 수 있는 자바스크립트 엔진이며, 오픈소스로 코드도 공개되었다.

2009년 라이언 달은 V8 엔진 기반의 노드 프로젝트를 시작했다.   
V8과 함께 노드에서 사용되는 **libuv라는 라이브러리**는 노드의 특성인 **이벤트 기반, 논블로킹 I/O 모델**을 구현하고 있다.

### 1.3. 이벤트 기반(event-driven)

이벤트(클릭, 네트워크 요청 등)가 발생할 때 미리 지정해둔 작업을 수행하는 방식  

특정 이벤트가 발생할 때 무엇을 할 지 미리 등록한다.  
이벤트 리스너(event listner)에 콜백(callback)함수를 등록한다.

발생한 이벤트가 없거나 발생했던 이벤트를 다 처리하면 노드는 다음 이벤트가 발생할 때까지 대기한다.

#### 1.3.1. 이벤트 루프

+ 이벤트 발생 시 호출할 콜백 함수들을 관리
+ 호출된 콜백 함수의 실행 순서를 결정
+ 종료될 때까지 이벤트 처리를 위한 작업을 반복

#### 1.3.2. 태스크 큐

+ 이벤트 발생 후 호출되어야 할 콜백 함수들이 기다리는 공간
+ 콜백들이 이벤트 루프가 정한 순서대로 줄을 서 있다.(콜백 큐라고도 부름)
+ 실제로는 여러 개의 큐로 이루어져 있다.

#### 1.3.3. 백그라운드 

+ 타이머나 I/O 작업 콜백 또는 이벤트 리스너들이 대기하는 곳

이벤트 루프 참고
+ [이벤트 루프 시각적 설명](http://latentflip.com/loupe/)
+ [이벤트 루프란?](https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/)

※ 호출 스택에 함수들이 너무 많이 차 있으면, 호출 스택이 비어있을 때만 태스크 큐에 있는 함수를 호출 스택에 가져오기 때문에, 예를들어 setTimeout으로 3초 뒤 함수가 실행되도록 지정해도 시간이 정확하지 않을 수 있다.
※ 실행 환경(실행 컨텍스트): 함수가 호출되었을 때 생성되는 환경

### 1.4. 논블로킹

이벤트 루프를 활용해 오래 걸리는 작업을 효율적으로 처리할 수 있다.  
오래 걸리는 함수를 백그라운드로 보내 다음 코드가 먼저 실행되게 하고, 그 함수가 다시 태스크 큐를 거쳐 호출 스택으로 올라오기를 기다리는 방식을 논블로킹 방식이라고 한다.  

이전 작업이 완료될 때까지 멈추지 않고 다음 작업을 수행한다. 비동기와 유사.

※ 싱글 스레드라는 한계 때문에 자바스크립트의 모든 코드가 이 방식으로 시간적 이득을 볼 수 있는 것은 아니다.  
노드 프로세스 외의 다른 컴퓨팅 자원을 사용할 수 있는 I/O 작업이 주로 시간적 이득을 많이 본다.

#### 1.4.1. I/O(Input/Ouput)

입력/출력, 파일 시스템 접근(CRUD)이나 네트워크 요청같은 작업이 I/O의 일종.  
이러한 작업을 할 때 노드는 논블로킹 방식으로 동작한다.

```js
// setTimeout을 이용한 논블로킹 방식의 코드
function longRunningTask() {
  // 오래 걸리는 작업이라 가정
  console.log('오래 걸리는 작업 끝')
}

console.log('시작');
setTimteout(longRunningTask, 0);
console.log('다음 작업');
// 시작
// 다음 작업
// 오래 걸리는 작업 끝
```
※ `setTimeout(callback, 0)`은 HTML5 브라우저에서 4ms, 노드에서 1ms의 지연시간이 있다.

노드에서는 `setTimeout(callback, 0)` 대신 다른 방식을 주로 사용한다.

### 1.5. 싱글 스레드

스레드는 컴퓨터 작업을 처리할 수 있는 일손.  
싱글스레드란 주어진 작업을 혼자 처리해야 함을 의미한다.  
반면에 멀티 스레드인 시스템에서는 여러 개의 스레드가 일을 나눠서 처리한다. 

자바스크립트는 싱글 스레드이기 때문에 노드에서 논블로킹이 중요하다.  
단, 싱글 스레드는 한가지 일 밖에 처리하지 못해 어떤 작업에서 블로킹이 발생하면 다음 일을 처리하지 못한다.

- 프로세스
  - 운영체제에서 할당하는 작업의 단위. 
  - 노드나 인터넷 브라우저 같은 프로그램은 개별적인 프로세스  
  - 프로세스 간에는 메모리 등의 자원을 공유하지 않는다.
- 스레드
  - 프로세스 내에서 실행되는 흐름의 단위
  - 하나의 프로세스는 스레드를 여러개 가질 수 있다.
  - 스레드들은 부모 프로세스의 자원을 공유한다.(같은 메모리에 접근할 수 있다.)

노드 프로세스는 내부적으로 스레드를 여러 개 가지고 있지만, 우리가 직접 제어할 수 있는 스레드는 하나뿐이므로 흔히 싱글 스레드라고 부른다.  
노드는 스레드를 늘리는 대신, 프로세스 자체를 복사해 여러 작업을 동시에 처리하는 **멀티 프로세싱** 방식을 택했다.

## 2. 서버로서의 노드, 서버 외의 노드

### 2.1. 서버로서의 노드 

노드 서버의 장단점은 싱글 스레드, 논블로킹 모델의 장단점과 크게 다르지 않다.  

| 장점 | 단점 | 
| --- | --- |
| 멀티 스레드 방식보다는 컴퓨터 자원을 적게 사용한다. | 싱글 스레드여서 CPU 코어를 하나밖에 사용하지 못한다. |
| libuv 라이브러리를 사용해 I/OP작업을 논블로킹 방식으로 처리해주므로 I/O가 많은 작업에 적합하다. | 모든 코드가 스레드 하나에서 처리되므로 CPU 연산을 많이 요구하면 블로킹이 발생하기 때문에 CPU 부하가 큰 작업에 적합하지 않다. |
| 멀티 스레드 방식보다 프로그래밍하기 상대적으로 쉽다. | 하나뿐인 스레드가 에러로 인해 멈추지 않게 잘 관리해야 한다.(에러 처리를 제대로 해야한다.) |
| 웹 서버가 내장되어 있어 Apache, nginx, IIS처럼 별도의 웹서버를 설치하거나 따로 사용법을 익힐 필요가 없어 입문자가 쉽게 접근할 수 있다. | 서버 규모가 커지면 결국 ngnix 등의 웹서버를 노드 서버와 연결해야 해 관리가 쉽지 않다. |
| 언어로 자바스크립트를 사용한다. 생산성이 좋다 | 어중간한 성능. 비동기에 강점을 보이지만, 정적파일 제공, 로드 밸런싱에 특화된 서버에 비하면 속도가 느리다 |
| JSON 형식과 호환하기 쉽다. | |

노드의 특성을 활용해 다음과 같은 경우에 사용하면 좋다.
- 개수는 많지만 크기는 작은 데이터를 실시간으로 주고 받는데 적합하다.
- 네트워크나 데이터베이스, 디스크 작업 같은 I/O에 특화되어 있다.
- 실시간 채팅 애플리케이션, 주식 차트, JSON 데이터를 제공하는 API 서버가 노드를 많이 사용한다.

노드의 특성 상 다음과 같은 경우에는 추천하지 않는다.
- 이미지, 비디오 처리, 대규모 데이터 처리 등 CPU를 많이 사용하는 작업을 위한 서버
- 단, AWS Lambda나 Google Cloud Functions 같은 서비스에서 노드로 CPU를 많이 사용하는 작업을 처리하는 것을 지원한다.

노드가 다른 서버에 비해 쇼핑몰, 블로그처럼 콘텐츠를 제공하는 데 뚜렷한 장점은 없지만 적합하지 않은 것은 아니며, Pug, EJS 같은 템플릿 엔진을 통해 다른 언어와 비슷하게 콘텐츠를 제공할 수 있다.

### 2.2. 서버 외 노드

노드는 자바스크립트 런타임이므로 용도가 서버에만 한정되지 않는다.  
웹, 모바일, 데스크톱 애플리케이션 개발에도 사용된다. 

노드 기반으로 돌아가는 
- 웹 프레임워크: Angular, React, Vue, Meteor...
- 모바일 개발 도구: React Native, Ionic Framework
- 데스크톱 개발 도구: Electron(VS Code, Atom, Slack, Discord등을 만듦)